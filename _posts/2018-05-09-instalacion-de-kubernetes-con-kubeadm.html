---

status: publish
published: true
title: Instalaci&oacute;n de kubernetes con kubeadm
author:
  display_name: admin
  login: admin
  email: josedom24@gmail.com
  url: ''
author_login: admin
author_email: josedom24@gmail.com
wordpress_id: 1986
wordpress_url: https://www.josedomingo.org/pledin/?p=1986
date: '2018-05-09 21:03:15 +0000'
date_gmt: '2018-05-09 19:03:15 +0000'
categories:
- General
tags:
- Cloud Computing
- docker
- kubernetes
comments: []
---
<p><a class="thumbnail" href="https://www.josedomingo.org/pledin/wp-content/uploads/2018/05/name_blue.png"><img src="https://www.josedomingo.org/pledin/wp-content/uploads/2018/05/name_blue.png" alt="" width="1600" height="237" class="aligncenter size-full wp-image-1988" /></a><br />
<a href="https://kubernetes.io/">Kubernetes</a> es un sistema de c&oacute;digo abierto que nos permite despliegues autom&aacute;ticos, escabilidad y gesti&oacute;n de contenedores de aplicaiones. <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">kubeadm</a> es una herramienta que nos permite el despliegue de un cluster de kubernetes de manera sencilla. El cluster lo podemos crear en m&aacute;quinas f&iacute;sicas o virtuales, en nuestro caso, vamos a usar Debian 9 en 3 m&aacute;quinas virtuales para realizar la instalaci&oacute;n.</p>
<h2>Instalaci&oacute;n de los paquetes necesarios</h2>
<h3>Instalaci&oacute;n de Docker</h3>
<p>Lo primero que hacemos, siguiendo las instrucciones de instalaci&oacute;n de <a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-using-the-repository">p&aacute;gina oficial</a>, es instalar la &uacute;ltima versi&oacute;n de docker, en los tres nodos:</p>
<pre><code>$ sudo apt-get update
</code></pre>
<p>Instalamos los paquetes que nos permiten usar repositorios <code>apt</code> con https:</p>
<pre><code>$ sudo apt-get install \
     apt-transport-https \
     ca-certificates \
     curl \
     gnupg2 \
     software-properties-common
</code></pre>
<p>A&ntilde;adimos las clves GPG oficales de Docker:</p>
<pre><code>$ curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
</code></pre>
<p>A&ntilde;adimos el repositorio para nuestra versi&oacute;n de Debian:</p>
<pre><code>$ sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/debian \
   $(lsb_release -cs) \
   stable"
</code></pre>
<p>Y por &uacute;ltimo instalamos docker:</p>
<pre><code>$ sudo apt-get update
$ sudo apt-get install docker-ce
</code></pre>
<p>Finalmente comprobamos la versi&oacute;n instalada:</p>
<pre><code>$ docker --version
Docker version 18.03.1-ce, build 9ee9f40
</code></pre>
<h3>Instalaci&oacute;n de kubeadm, kubelet and kubectl</h3>
<p>Vamos a instalar los siguientes pauqetes en nuestras m&aacute;quinas:</p>
<ul>
<li><code>kubeadm</code>: Instrucci&oacute;n que nos permite crear el cluster.</li>
<li><code>kubelet</code>: Es el componente de kubernetes que se ejecuta en todos los nodos y es responsable de ejecutar los pods y los contenedores.</li>
<li><code>kubectl</code>: La utilidad de l&iacute;nea de comandos que nos permite controlar el cluster.</li>
</ul>
<p>Para la instalaci&oacute;n, seguimos los pasos indicados en la documentaci&oacute;n:</p>
<pre><code>apt-get update &amp;&amp; apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get update
apt-get install -y kubelet kubeadm kubectl
</code></pre>
<p><!--more--></p>
<h2>Inicializando el nodo master</h2>
<p>En el nodo que vamos a usar como master, ejecutamos la siguiente instrucci&oacute;n como superusuario:</p>
<pre><code>$ kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-cert-extra-sans=172.22.201.15
</code></pre>
<p>Este comando inicializa el cluster, hemos indicado le CIDR de la red por donde se comunican los nodos del cluster.</p>
<blockquote>
<p>Estoy utilizando como instraestructura tres instancias de OpenStack, es necesario indicar el par&aacute;metro <code>--apiserver-cert-extra-sans</code> con la IP flotante del master para que el certificado que se genera sea v&aacute;lido para esta ip, y se pueda controlar el cluster desde el exterior.</p>
</blockquote>
<p>Cuando termina muestra un mensaje similar a este:</p>
<pre><code>Your Kubernetes master has initialized successfully!    

To start using your cluster, you need to run (as a regular  user):

  sudo cp /etc/kubernetes/admin.conf $HOME/
  sudo chown $(id -u):$(id -g) $HOME/admin.conf
  export KUBECONFIG=$HOME/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the    options listed at:
  http://kubernetes.io/docs/admin/addons/

You can now join any number of machines by running the  following on each node
as root:    

  kubeadm join --token <token> <master-ip>:<master-port>
</code></pre>
<p>Nos indica tres cosas:</p>
<ol>
<li>Las instrucciones que tenemos que ejecutar en el master, con un usuario sin privilegios para usar el cliente kubectl y manejar el claster.</li>
<li>La necesidad de instalar un pod para la gesti&oacute;n de la red.</li>
<li>Y la instrucci&oacute;n que tenemos que ejecutar en los nodos para a&ntilde;adirlos al cluster. Utilizaremos un token para ello.</li>
</ol>
<h2>Instalaci&oacute;n del pod para gestionar la red</h2>
<p>Antes de ello, en el master con un usuario con privilegios podemos usar el cliente <code>kubectl</code> ejecutando:</p>
<pre><code>export KUBECONFIG=/etc/kubernetes/admin.conf
</code></pre>
<p>A continuaci&oacute;n tenemos que instalar un pod que nos permita la comunicaci&oacute;n por red de los distintos pods que vamos a correr en el cluster. <code>kubeadm</code> solo soporta plugins de red CNI (Container Network Interface), que es un proyecto que consiste en crear especificaciones y librer&iacute;as para configure las redes que interconectan los contenedores. De las distintas alternativas vamos a instalar <code>Calico</code>, para ello:</p>
<pre><code>$ kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/kubeadm/1.7/calico.yaml
</code></pre>
<p>Y comprobamos que todos los pods del espacio de nombres <code>kube-system</code> est&aacute;n funcionando con normalidad:</p>
<pre><code>$ kubectl get pods -n kube-system
NAME                                       READY        STATUS    RESTARTS   AGE
calico-etcd-kxfp2                          1/1          Running   0          1d
calico-kube-controllers-5d74847676-fb9nl   1/1          Running   0          1d
calico-node-c8pjr                          2/2          Running   0          1d
calico-node-g8xpt                          2/2          Running   0          1d
calico-node-q5ls4                          2/2          Running   0          1d
etcd-k8s-1                                 1/1          Running   0          1d
kube-apiserver-k8s-1                       1/1          Running   0          1d
kube-controller-manager-k8s-1              1/1          Running   0          1d
kube-dns-86f4d74b45-828lm                  3/3          Running   0          1d
kube-proxy-9jmdn                           1/1          Running   0          1d
kube-proxy-pjr2b                           1/1          Running   0          1d
kube-proxy-xqsmg                           1/1          Running   0          1d
kube-scheduler-k8s-1                       1/1          Running   0          1d
</code></pre>
<h2>Uniendo los nodos al cluster</h2>
<p>En cada nodo que va a formar parte del cluster tenemos que ejecutar, como superusuario, el comando que nos ofreci&oacute; el comando <code>kubeadm</code> al iniciar el cluster en el master:</p>
<pre><code>kubeadm join --token <token> <master-ip>:<master-port>
...
Node join complete:
* Certificate signing request sent to master and response
  received.
* Kubelet informed of new secure connection details.    

Run 'kubectl get nodes' on the master to see this machine join.
</code></pre>
<p>Y finalmente desde el master podemos obtener los nodos que forman el cluster:</p>
<pre><code># kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
k8s-1     Ready     master    1d        v1.10.2
k8s-2     Ready     <none>    1d        v1.10.2
k8s-3     Ready     <none>    1d        v1.10.2
</code></pre>
<h2>Acceso desde un cliente externo</h2>
<p>Normalmente vamos a interactuar con el cluster desde un clinete externo donde tengamos instaldo <code>kubectl</code>. Para instalar <code>kubectl</code>, siguiendo las <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-native-package-management">instrucciones oficiales</a>, ejecutamos:</p>
<pre><code>apt-get update &amp;&amp; apt-get install -y apt-transport-https
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get update
apt-get install -y kubectl
</code></pre>
<p>Y para configurar el acceso al cluster:</p>
<ol>
<li>
<p>Desde el nodo master damos permisos de lectura al fichero <code>/etc/kubernetes/admin.conf</code>:</p>
<pre><code>chmod 644 /etc/kubernetes/admin.conf
</code></pre>
</li>
<li>
<p>Desde el cliente:</p>
<pre><code>export IP_MASTER=172.22.201.15
sftp debian@${IP_MASTER}
sftp> get /etc/kubernetes/admin.conf
sftp> exit

mv admin.conf ~/.kube/mycluster.conf
sed -i -e "s#server: https://.*:6443#server: https://${IP_MASTER}:6443#g" ~/.kube/mycluster.conf
export KUBECONFIG=~/.kube/mycluster.conf
</code></pre>
</li>
</ol>
<p>Y comprobamos que tenemos acceso al cluster:</p>
<pre><code>$ kubectl cluster-info
Kubernetes master is running at https://172.22.201.15:6443
</code></pre>
<h2>Puertos necesarios para acceder al cluster de Kubernetes</h2>
<p>Si instalamos el cluster en instancias de un servicio cloud de infraestuctura hay que tener en cuanta que los siguientes puertos deben estar accesibles:</p>
<ul>
<li><code>80</code>: Para acceder a los servicios con el controlador <code>Ingress</code>.</li>
<li><code>443</code>: Para acceder a los servicios con el controlador <code>Ingress</code> y HTTPS.</li>
<li><code>6443</code>: Para acceder a la API de Kubernetes.</li>
<li><code>30000-40000</code>: Para acceder a las aplicaciones con el servicio <code>NodePort</code>.</li>
</ul>
